<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JWT Auth Test</title>
</head>
<body>
  <h1>JWT Auth Test</h1>

  <button onclick="signIn()">ğŸ” Zaloguj siÄ™</button>
  <button onclick="getProfile()">ğŸ“„ Pobierz profil</button>
  <button onclick="sendVerification()">ğŸ“§ PotwierdÅº e-mail</button>
  <button onclick="connectWithBank()">ğŸ¦ PoÅ‚Ä…cz z bankiem</button>
  <button onclick="loadTransactions()">ğŸ’¸ Pobierz transakcje</button>

  <hr>

  <h2>ğŸ§  Zadaj pytanie asystentowi</h2>
  <form onsubmit="askAssistant(event)">
    <input type="text" id="prompt" placeholder="Napisz pytanie..." style="width: 300px;">
    <button type="submit">ğŸ“¨ WyÅ›lij</button>
  </form>
  <pre id="assistant-response"></pre>

  <h3>ğŸ“Š Twoje transakcje</h3>
  <div id="transactions-table"></div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    function signIn() {
      fetch(`${API_BASE}/sign-in/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ email: "klawy@gmail.com", password: "1234" })
      })
      .then(res => res.json())
      .then(data => {
        console.log("âœ… Zalogowano:", data);
        alert("Zalogowano! SprawdÅº konsolÄ™.");
      })
      .catch(err => console.error("âŒ BÅ‚Ä…d logowania:", err));
    }

    function getProfile() {
      fetch(`${API_BASE}/profile/`, {
        method: "POST",
        credentials: "include"
      })
      .then(res => res.json())
      .then(data => {
        console.log("ğŸ“„ Profil uÅ¼ytkownika:", data);
        alert("Profil zaÅ‚adowany! SprawdÅº konsolÄ™.");
      })
      .catch(err => console.error("âŒ BÅ‚Ä…d pobierania profilu:", err));
    }

    function sendVerification() {
      fetch(`${API_BASE}/email-verify/?mode=0`, {
        method: "GET",
        credentials: "include"
      })
      .then(res => res.json())
      .then(data => {
        console.log("ğŸ“§ Weryfikacja e-maila:", data);
        alert(data.message);
      })
      .catch(err => console.error("âŒ BÅ‚Ä…d przy wysyÅ‚ce e-maila:", err));
    }

    function askAssistant(event) {
      event.preventDefault();
      const prompt = document.getElementById("prompt").value;

      fetch(`${API_BASE}/ask-assistant`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ prompt: prompt })
      })
      .then(res => res.json())
      .then(data => {
        console.log("ğŸ¤– OdpowiedÅº asystenta:", data);
        document.getElementById("assistant-response").innerText = data.message || "Brak odpowiedzi.";
      })
      .catch(err => {
        console.error("âŒ BÅ‚Ä…d zapytania:", err);
        document.getElementById("assistant-response").innerText = "BÅ‚Ä…d podczas zapytania do asystenta.";
      });
    }

    function connectWithBank() {
      const institutionId = prompt("Podaj ID banku (np. SANDBOX-MBANK, PKO_BPKOPLPW, etc.):");

      if (!institutionId) return;

      fetch(`${API_BASE}/connect-bank/`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bank_name: institutionId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.code === 1 && data.link) {
          console.log("ğŸ”— Link do banku:", data.link);
          window.location.href = data.link;
        } else {
          alert("âŒ Nie udaÅ‚o siÄ™ utworzyÄ‡ poÅ‚Ä…czenia: " + data.message);
        }
      })
      .catch(err => {
        console.error("âŒ BÅ‚Ä…d poÅ‚Ä…czenia z bankiem:", err);
        alert("âŒ BÅ‚Ä…d poÅ‚Ä…czenia z bankiem.");
      });
    }

    function loadTransactions() {
    fetch(`${API_BASE}/test-transactions`, {
      method: "GET",
      credentials: "include"
    })
    .then(res => res.json())
    .then(data => {
      if (data.code !== 1) {
        alert("âŒ Nie udaÅ‚o siÄ™ pobraÄ‡ transakcji: " + data.message);
        return;
      }

      const transactions = data.message.booked || data.message; // jeÅ›li struktura to { booked: [...] }

      if (!Array.isArray(transactions) || transactions.length === 0) {
        document.getElementById("transactions-table").innerHTML = "Brak transakcji.";
        return;
      }

      // Pobierz unikalne klucze z pierwszego obiektu
      const keys = Object.keys(transactions[0]);

      let tableHtml = "<table border='1' cellpadding='5'><tr>";
      keys.forEach(key => {
        tableHtml += `<th>${key}</th>`;
      });
      tableHtml += "</tr>";

      transactions.forEach(tx => {
        tableHtml += "<tr>";
        keys.forEach(key => {
          let val = tx[key];

          // JeÅ¼eli wartoÅ›Ä‡ jest obiektem, zrÃ³b JSON.stringify
          if (typeof val === "object" && val !== null) {
            val = JSON.stringify(val);
          }

          tableHtml += `<td>${val ?? ""}</td>`;
        });
        tableHtml += "</tr>";
      });

      tableHtml += "</table>";
      document.getElementById("transactions-table").innerHTML = tableHtml;
    })
    .catch(err => {
      console.error("âŒ BÅ‚Ä…d przy pobieraniu transakcji:", err);
      alert("âŒ WystÄ…piÅ‚ bÅ‚Ä…d.");
    });
  }
  </script>
</body>
</html>